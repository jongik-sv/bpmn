#!/usr/bin/env node

/**
 * Enhanced WebSocket server for Yjs collaboration with server-side persistence
 * Features: Real-time collaboration + Centralized document storage
 */

const WebSocket = require('ws')
const http = require('http')
const { setupWSConnection } = require('y-websocket/bin/utils')
const Y = require('yjs')
const debounce = require('lodash.debounce')

const host = process.env.HOST || 'localhost'
const port = process.env.PORT || 1234

// ë¬¸ì„œë³„ Y.Doc ì €ì¥ì†Œ ë° ì €ì¥ ìƒíƒœ ê´€ë¦¬
const documents = new Map() // roomId -> Y.Doc
const documentMetadata = new Map() // roomId -> { diagramId, lastSaved, saveInProgress, lastChanged, forceSaveTimeout, connections }
const saveQueue = new Map() // roomId -> save function

// Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (ì„œë²„ ì¸¡)
const { createClient } = require('@supabase/supabase-js')
const supabaseUrl = process.env.SUPABASE_URL || 'https://yigkpwxaemgcasxtopup.supabase.co'
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || 'your-service-role-key'

let supabase = null

// ê°œë°œ í™˜ê²½ì—ì„œëŠ” Supabase ì—°ê²°ì„ ì„ íƒì ìœ¼ë¡œ ì²˜ë¦¬
if (supabaseUrl.includes('your-project.supabase.co') || supabaseServiceKey === 'your-service-role-key') {
  console.log('âš ï¸ Supabase not configured properly - documents will only persist in memory')
  console.log('ğŸ’¡ To enable database persistence, set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables')
} else {
  try {
    supabase = createClient(supabaseUrl, supabaseServiceKey)
    console.log('âœ… Supabase client initialized for server-side persistence')
  } catch (error) {
    console.warn('âš ï¸ Supabase connection failed - documents will only persist in memory:', error.message)
  }
}

/**
 * ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¬¸ì„œ ë¡œë“œ
 */
async function loadDocumentFromDatabase(diagramId) {
  if (!supabase) {
    console.log(`ğŸ“ Loading document ${diagramId} - Supabase not configured, using in-memory only`)
    return null
  }

  try {
    console.log(`ğŸ“– DBì—ì„œ ë¬¸ì„œ ë¡œë“œ ì¤‘...`)

    const { data, error } = await supabase
      .from('diagrams')
      .select('bpmn_xml, name, updated_at')
      .eq('id', diagramId)
      .single()

    if (error) {
      if (error.code === 'PGRST116') {
        console.log(`ğŸ“„ ë¬¸ì„œë¥¼ DBì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ - ìƒˆ ë¬¸ì„œ ìƒì„±`)
      } else {
        console.error(`âŒ ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨:`, error)
      }
      return null
    }

    console.log(`âœ… DBì—ì„œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ: ${data.name}`)
    return data

  } catch (error) {
    console.warn(`âš ï¸ DB ë¡œë“œ ì˜¤ë¥˜, ë©”ëª¨ë¦¬ ì‚¬ìš©:`, error.message)
    return null
  }
}

/**
 * ì„œë²„ ì¸¡ ë¬¸ì„œ ì €ì¥ í•¨ìˆ˜
 */
async function saveDocumentToDatabase(roomId, ydoc, reason = 'unknown') {
  if (!supabase) {
    console.log(`ğŸ“ ë¬¸ì„œ ì €ì¥ - Supabase ë¯¸ì„¤ì •, ë©”ëª¨ë¦¬ ì „ìš©`)
    return false
  }

  const metadata = documentMetadata.get(roomId)
  if (!metadata || !metadata.diagramId) {
    console.warn(`âš ï¸ ë¬¸ì„œ ID ì—†ìŒ: ${roomId}`)
    return false
  }

  if (metadata.saveInProgress) {
    console.log(`â³ ì €ì¥ ì§„í–‰ ì¤‘: ${metadata.name || roomId}`)
    return false
  }

  metadata.saveInProgress = true

  try {
    // Y.Docì—ì„œ BPMN XML ì¶”ì¶œ
    const bpmnMap = ydoc.getMap('bpmn-diagram')
    const bpmnXml = bpmnMap.get('xml')

    if (!bpmnXml) {
      console.warn(`âš ï¸ BPMN XML ì—†ìŒ: ${metadata.name || roomId}`)
      return false
    }

    console.log(`ğŸ’¾ DBì— ì €ì¥ ì¤‘: ${metadata.name || roomId} (${reason})`)

    const { data, error } = await supabase
      .from('diagrams')
      .update({
        bpmn_xml: bpmnXml,
        updated_at: new Date().toISOString(),
        last_modified_by: metadata.lastModifiedBy || null
      })
      .eq('id', metadata.diagramId)

    if (error) {
      console.warn(`âš ï¸ DB ì €ì¥ ì‹¤íŒ¨: ${metadata.name || roomId}`, error.message)
      console.log(`ğŸ“ ë©”ëª¨ë¦¬ì—ì„œ ìœ ì§€`)
      return false
    }

    metadata.lastSaved = Date.now()
    console.log(`âœ… DB ì €ì¥ ì™„ë£Œ: ${metadata.name || roomId}`)
    return true

  } catch (error) {
    console.warn(`âš ï¸ DB ì €ì¥ ì˜¤ë¥˜: ${metadata.name || roomId}`, error.message)
    return false
  } finally {
    metadata.saveInProgress = false
  }
}

/**
 * ìƒˆë¡œìš´ ì €ì¥ ì „ëµ êµ¬í˜„
 */
function setupSaveStrategies(roomId) {
  const metadata = documentMetadata.get(roomId)
  if (!metadata) return

  // 1. 10ì´ˆ ë””ë°”ìš´ìŠ¤ ì €ì¥ í•¨ìˆ˜
  const debouncedSave = debounce(async () => {
    const ydoc = documents.get(roomId)
    if (ydoc) {
      await saveDocumentToDatabase(roomId, ydoc, '10s-debounce')
    }
  }, 10000) // 10ì´ˆ ë””ë°”ìš´ìŠ¤

  // 2. 1ë¶„ ê°•ì œ ì €ì¥ íƒ€ì´ë¨¸ ì„¤ì •
  function scheduleForceSave() {
    // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
    if (metadata.forceSaveTimeout) {
      clearTimeout(metadata.forceSaveTimeout)
    }

    // 1ë¶„ í›„ ê°•ì œ ì €ì¥
    metadata.forceSaveTimeout = setTimeout(async () => {
      const ydoc = documents.get(roomId)
      if (ydoc) {
        const metadata = documentMetadata.get(roomId)
        const docName = metadata ? metadata.name : roomId
        console.log(`â° 1ë¶„ ê°•ì œ ì €ì¥: ${docName}`)
        await saveDocumentToDatabase(roomId, ydoc, '1min-force')
      }
    }, 60000) // 1ë¶„
  }

  return { debouncedSave, scheduleForceSave }
}

/**
 * ë¬¸ì„œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
 */
async function setupDocumentPersistence(roomId, ydoc, diagramId) {
  console.log(`ğŸ”§ í˜‘ì—… ì„¸ì…˜ ì„¤ì • ì¤‘: ${roomId} (ë¬¸ì„œ ID: ${diagramId})`)

  // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¬¸ì„œ ë¡œë“œ
  const dbDocument = await loadDocumentFromDatabase(diagramId)
  const documentName = dbDocument ? dbDocument.name : 'ìƒˆ ë¬¸ì„œ'
  
  // ë©”íƒ€ë°ì´í„° ì €ì¥
  documentMetadata.set(roomId, {
    diagramId,
    name: documentName,
    lastSaved: 0,
    saveInProgress: false,
    lastModifiedBy: null,
    lastChanged: 0,
    forceSaveTimeout: null,
    connections: 0
  })

  // ìƒˆë¡œìš´ ì €ì¥ ì „ëµ ì„¤ì •
  const { debouncedSave, scheduleForceSave } = setupSaveStrategies(roomId)
  saveQueue.set(roomId, { debouncedSave, scheduleForceSave })

  // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¬¸ì„œ ë¡œë“œ ë° Y.Docì— ì„¤ì •
  if (dbDocument && dbDocument.bpmn_xml) {
    console.log(`ğŸ“– ê¸°ì¡´ ë¬¸ì„œ ë¡œë“œ: ${documentName}`)
    const bpmnMap = ydoc.getMap('bpmn-diagram')
    bpmnMap.set('xml', dbDocument.bpmn_xml)
    documentMetadata.get(roomId).lastSaved = Date.now()
  } else {
    console.log(`ğŸ“„ ìƒˆ ë¬¸ì„œ ìƒì„±: ${documentName}`)
  }

  // Y.Doc ë³€ê²½ ì‹œ ì €ì¥ ë¡œì§
  ydoc.on('update', () => {
    const metadata = documentMetadata.get(roomId)
    if (!metadata) return

    const now = Date.now()
    metadata.lastChanged = now

    console.log(`ğŸ“ ë¬¸ì„œ ìˆ˜ì •ë¨: ${metadata.name}`)
    
    // 10ì´ˆ ë””ë°”ìš´ìŠ¤ ì €ì¥
    debouncedSave()
    
    // 1ë¶„ ê°•ì œ ì €ì¥ íƒ€ì´ë¨¸ ì¬ì„¤ì •
    scheduleForceSave()
  })

  console.log(`âœ… í˜‘ì—… ì„¸ì…˜ ì¤€ë¹„ ì™„ë£Œ: ${documentName}`)
  return { documentName, hasExistingData: !!(dbDocument && dbDocument.bpmn_xml) }
}

const server = http.createServer((request, response) => {
  response.writeHead(200, { 'Content-Type': 'text/plain' })
  response.end('Enhanced Yjs WebSocket Server with Persistence\n')
})

const wss = new WebSocket.Server({ 
  server,
  perMessageDeflate: {
    zlibDeflateOptions: {
      threshold: 1024
    }
  }
})

console.log(`WebSocket server starting on ${host}:${port}`)

wss.on('connection', async (conn, req) => {
  console.log('ìƒˆ WebSocket ì—°ê²°:', req.socket.remoteAddress)
  
  // URLì—ì„œ room IDì™€ diagram ID íŒŒì‹±
  const url = new URL(req.url, `http://${req.headers.host}`)
  const roomId = url.pathname.slice(1) // Remove leading slash
  const diagramId = url.searchParams.get('diagramId')
  
  // ê¸°ì¡´ Y.Docì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œ ìƒì„±
  let ydoc = documents.get(roomId)
  let isNewRoom = false
  let documentInfo = null
  
  if (!ydoc) {
    // ìƒˆ ë£¸ ìƒì„±
    ydoc = new Y.Doc()
    documents.set(roomId, ydoc)
    isNewRoom = true
    
    // ë‹¤ì´ì–´ê·¸ë¨ IDê°€ ìˆìœ¼ë©´ ë¬¸ì„œ ì €ì¥ ì„¤ì • ë° DBì—ì„œ ë¡œë“œ
    if (diagramId) {
      documentInfo = await setupDocumentPersistence(roomId, ydoc, diagramId)
      console.log(`ğŸ‘¤ ì‚¬ìš©ìê°€ ë¬¸ì„œì— ì ‘ì†: ${documentInfo.documentName}`)
    } else {
      console.log(`ğŸ‘¤ ì‚¬ìš©ìê°€ ë£¸ì— ì ‘ì†: ${roomId}`)
    }
  } else {
    // ê¸°ì¡´ ë£¸ - ë¬¸ì„œ ì´ë¦„ ì¶œë ¥
    const metadata = documentMetadata.get(roomId)
    const docName = metadata ? metadata.name : roomId
    console.log(`ğŸ‘¤ ì‚¬ìš©ìê°€ ë¬¸ì„œì— ì ‘ì†: ${docName}`)
  }
  
  // ì—°ê²° ìˆ˜ ì¦ê°€
  const metadata = documentMetadata.get(roomId)
  if (metadata) {
    metadata.connections++
    console.log(`ğŸ‘¥ ${metadata.name} ì ‘ì†ì ìˆ˜: ${metadata.connections}`)
  }
  
  // Yjs WebSocket ì—°ê²° ì„¤ì •
  setupWSConnection(conn, req, { docName: roomId, gc: true })
  
  // ìƒˆ ë£¸ì´ê³  DBì—ì„œ ë¬¸ì„œë¥¼ ë¡œë“œí–ˆë‹¤ë©´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ë™ê¸°í™”
  if (isNewRoom && documentInfo && documentInfo.hasExistingData) {
    // ì§§ì€ ì§€ì—° í›„ ë™ê¸°í™” (í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì™„ë£Œ ëŒ€ê¸°)
    setTimeout(() => {
      console.log(`ğŸ“¤ ë¬¸ì„œ ë‚´ìš© ì¦‰ì‹œ ë™ê¸°í™”: ${documentInfo.documentName}`)
    }, 100)
  }
  
  conn.on('close', async () => {
    const metadata = documentMetadata.get(roomId)
    const docName = metadata ? metadata.name : roomId
    console.log(`ğŸ”Œ ì‚¬ìš©ìê°€ ë¬¸ì„œì—ì„œ ë‚˜ê°: ${docName}`)
    
    // ì—°ê²° ìˆ˜ ê°ì†Œ
    if (metadata) {
      metadata.connections--
      console.log(`ğŸ‘¥ ${metadata.name} ì ‘ì†ì ìˆ˜: ${metadata.connections}`)
      
      // ë§ˆì§€ë§‰ ì‚¬ìš©ìê°€ ë‚˜ê°€ë©´ ì €ì¥ í›„ ë£¸ ì •ë¦¬
      if (metadata.connections <= 0) {
        console.log(`ğŸ§¹ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë‚˜ê°, ë¬¸ì„œ ì €ì¥ ë° ì •ë¦¬: ${metadata.name}`)
        
        const ydoc = documents.get(roomId)
        if (ydoc) {
          await saveDocumentToDatabase(roomId, ydoc, 'room-cleanup')
        }
        
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (metadata.forceSaveTimeout) {
          clearTimeout(metadata.forceSaveTimeout)
        }
        
        // ë£¸ ì •ë¦¬ (5ë¶„ í›„)
        setTimeout(() => {
          const currentMetadata = documentMetadata.get(roomId)
          if (currentMetadata && currentMetadata.connections <= 0) {
            console.log(`ğŸ—‘ï¸ ë£¸ ì •ë¦¬ ì™„ë£Œ: ${currentMetadata.name}`)
            documents.delete(roomId)
            documentMetadata.delete(roomId)
            saveQueue.delete(roomId)
          }
        }, 5 * 60 * 1000) // 5ë¶„
      }
    }
  })
})

wss.on('error', (error) => {
  console.error('WebSocket server error:', error)
})

server.listen(port, host, () => {
  console.log(`âœ… WebSocket server running on ws://${host}:${port}`)
})

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\nğŸ”„ Shutting down WebSocket server...')
  wss.close(() => {
    server.close(() => {
      console.log('âœ… WebSocket server closed')
      process.exit(0)
    })
  })
})

process.on('SIGTERM', () => {
  console.log('\nğŸ”„ Shutting down WebSocket server...')
  wss.close(() => {
    server.close(() => {
      console.log('âœ… WebSocket server closed')
      process.exit(0)
    })
  })
})